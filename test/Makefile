# Test Makefile
TEST_TARGET = ../build/test_runner
CC = clang
CFLAGS = -Wall -Wextra -O2 -std=c99 -I../src -MMD -MP `llvm-config --cflags`
LDFLAGS = `llvm-config --ldflags --libs --system-libs`

# Source files
TEST_SRCS = $(wildcard *.c)
PRODUCT_SRCS = $(filter-out ../src/main.c, $(wildcard ../src/*.c))

ALL_SRCS = $(TEST_SRCS) $(PRODUCT_SRCS)

# Object files - auto-generated from sources
TEST_OBJS = $(patsubst %.c,../build/test_%.o,$(TEST_SRCS))
PRODUCT_OBJS = $(patsubst ../src/%.c,../build/%.o,$(PRODUCT_SRCS))
ALL_OBJS = $(PRODUCT_OBJS) $(TEST_OBJS)

# Dependency files (.d files are auto-generated by compiler with -MMD flag)
DEPS = $(ALL_OBJS:.o=.d)

# Default target
.PHONY: all test run clean format
all: $(TEST_TARGET)

# Include generated dependency files
-include $(DEPS)

# Build directory
BUILD_DIR = ../build

test run: $(TEST_TARGET)
	@$(TEST_TARGET)

# Build test executable
$(TEST_TARGET): $(BUILD_DIR) $(ALL_OBJS)
	@echo "Building test runner..."
	$(CC) $(CFLAGS) -o $(TEST_TARGET) $(ALL_OBJS) $(LDFLAGS)
	@chmod +x $(TEST_TARGET)

# Product object files
../build/%.o: ../src/%.c | $(BUILD_DIR)
	@echo $(CC) $(CFLAGS) -c $< -o $@
	$(CC) $(CFLAGS) -c $< -o $@

# Test object files
../build/test_%.o: %.c | $(BUILD_DIR)
	@echo $(CC) $(CFLAGS) -c $< -o $@
	$(CC) $(CFLAGS) -c $< -o $@

# Build directory
$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

# Clean
clean:
	rm -rf $(BUILD_DIR)/test_*.o $(BUILD_DIR)/test_runner $(BUILD_DIR)/*.d

# Format
format:
	clang-format -i $(ALL_SRCS)
