# Test Makefile
TEST_TARGET = ../build/test_runner
CC = clang
CFLAGS = -Wall -Wextra -O2 -std=c99 -I../src -MMD -MP `llvm-config --cflags`
LDFLAGS = `llvm-config --ldflags --libs --system-libs`

# Source files
TEST_SRCS = main.c generate_test.c lexer_test.c test_common.c
PRODUCT_SRCS = $(filter-out ../src/main.c, $(shell find ../src -name '*.c'))

# Object files - use pattern substitution
PRODUCT_OBJS = $(PRODUCT_SRCS:../src/%.c=../build/%.o)
TEST_OBJS = $(TEST_SRCS:%.c=../build/test_%.o)
ALL_OBJS = $(PRODUCT_OBJS) $(TEST_OBJS)

# Dependency files (.d files are auto-generated by compiler with -MMD flag)
# Each .d file contains make rules for header dependencies
# Example: ../build/test_main.d contains:
#   ../build/test_main.o: main.c generate_test.h lexer_test.h ../src/lexer.h test_common.h
# When any header changes, make knows to rebuild the corresponding .o file
DEPS = $(ALL_OBJS:.o=.d)

# Build directory
BUILD_DIR = ../build

# Default target
.PHONY: all
all: $(TEST_TARGET)

# Build test executable
$(TEST_TARGET): $(BUILD_DIR) $(ALL_OBJS)
	@echo "Building test runner..."
	$(CC) $(CFLAGS) -o $(TEST_TARGET) $(ALL_OBJS) $(LDFLAGS)
	@chmod +x $(TEST_TARGET)

# Product object files with auto-generated dependencies
../build/%.o: ../src/%.c | $(BUILD_DIR)
	@echo $(CC) $(CFLAGS) -c $< -o $@
	$(CC) $(CFLAGS) -c $< -o $@

# Test object files with auto-generated dependencies
../build/test_%.o: %.c | $(BUILD_DIR)
	@echo $(CC) $(CFLAGS) -c $< -o $@
	$(CC) $(CFLAGS) -c $< -o $@

# Include generated dependency files
# The - prefix means "include if exists, don't error if missing"
# This loads all .d files created by compiler with -MMD flag
# Each contains rules like: ../build/test_main.o: main.c ...headers...
# So when headers change, make automatically rebuilds affected .o files
-include $(DEPS)

# Run tests
.PHONY: test
test: $(TEST_TARGET)
	@echo "Running tests..."
	$(TEST_TARGET)

.PHONY: format
format:
	clang-format -i *.c *.h

# Create build directory
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Clean
.PHONY: clean
clean:
	rm -rf $(BUILD_DIR) $(TEST_TARGET)

.PHONY: clean_deps
clean_deps:
	rm -f $(DEPS)
